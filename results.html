<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Калькулятор услуг склада - Итоговый расчёт</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="results-bg">
  <!-- Header с заголовком и индикатором прогресса -->
  <header>
    <h1>Калькулятор услуг склада</h1>
    <div class="progress-bar">
      <div class="step active">1</div>
      <div class="step active">2</div>
      <div class="step active">3</div>
    </div>
  </header>

  <!-- Основной блок с результатами расчёта -->
  <div class="content">
    <h2>Итоговый расчёт услуг склада</h2>
    <!-- Контейнер для динамически создаваемых блоков с информацией по каждому товару -->
    <div id="resultsContainer"></div>
    <!-- Кнопки для печати результатов и сброса расчёта -->
    <div class="buttons">
      <button onclick="printResults()">Распечатать результаты</button>
      <button onclick="resetCalculation()">Новый расчёт</button>
    </div>
  </div>

  <script>
    // Массив услуг – используйте для расчёта стоимости. Если нужно изменить тарифы, измените данные здесь.
    const services = [
      { name: "Погрузо-разгрузочные работы", unit: "Короб", rates: [6.70, 5.70, 4.70] },
      { name: "Пересчет BOX", unit: "Короб", rates: [2.10, 2.00, 1.80] },
      { name: "Пересчет PCS", unit: "Штука", rates: [0.60, 0.40, 0.20] },
      { name: "Идентификация", unit: "Строка", rates: [20.00, 20.00, 20.00] },
      { name: "Видео подтверждение товара", unit: "Строка", rates: [47.97, 47.97, 47.97] },
      { name: "Проверка целостности упаковки", unit: "Штука", rates: [0.69, 0.59, 0.49] },
      { name: "Проверка внешней поверхности изделия", unit: "Штука", rates: [0.69, 0.59, 0.46] },
      { name: "Проверка внутренней поверхности изделия", unit: "Штука", rates: [0.69, 0.59, 0.46] },
      { name: "Проверка комплектации", unit: "Штука", rates: [0.67, 0.57, 0.47] },
      { name: "Проверка на отсутствие резкого запаха", unit: "Штука", rates: [1.10, 1.10, 1.10] },
      { name: "Обрезка ниток", unit: "Штука", rates: [1.50, 1.50, 1.50] },
      { name: "Проверка карманов", unit: "Штука", rates: [1.50, 1.50, 1.50] },
      { name: "Проверка швов", unit: "Штука", rates: [1.50, 1.50, 1.50] },
      { name: "Устранение баркодов", unit: "Штука", rates: [0.70, 0.70, 0.70] },
      { name: "Проверка при подключении к источнику питания", unit: "Штука", rates: [2.57, 2.27, 1.97] },
      { name: "Проверка элементов управления", unit: "Штука", rates: [2.57, 2.27, 1.97] },
      { name: "Проверка работы комплекта", unit: "Штука", rates: [2.57, 2.27, 1.97] },
      { name: "Проверка проводных звуковых устройств", unit: "Штука", rates: [2.97, 2.97, 2.97] },
      { name: "Проверка беспроводных звуковых устройств", unit: "Штука", rates: [2.97, 2.97, 2.97] },
      { name: "Проверка внешних накопителей", unit: "Штука", rates: [2.97, 2.97, 2.97] },
      { name: "Проклейка баркодов", unit: "Штука", rates: [0.85, 0.75, 0.65] },
      { name: "Создание набора: Типография", unit: "Штука", rates: [0.87, 0.83, 0.79] },
      { name: "Создание набора: Товар", unit: "Штука", rates: [1.57, 1.47, 1.37] },
      { name: "Упаковка в пакеты клиента", unit: "Штука", rates: [0.55, 0.50, 0.45] },
      { name: "Проверка фурнитуры и декоративных элементов", unit: "Штука", rates: [2.97, 2.97, 2.97] },
      { name: "Распечатка баркодов", unit: "Штука", rates: [0.11, 0.11, 0.11] },
      { name: "Хранение", unit: "Куб", rates: [7.77, 7.77, 7.77] },
      { name: "Тест экрана", unit: "Штука", rates: [2.97, 2.97, 2.97] },
      { name: "Проверка по ТЗ", unit: "Штука", rates: [5.00, 5.00, 5.00] }
    ];
    
    // Получаем товары из sessionStorage
    function getProducts() {
      return JSON.parse(sessionStorage.getItem('productsData')) || [];
    }
    // Функция расчёта и вывода результатов
    function calculateAndDisplay() {
      const products = getProducts();
      const container = document.getElementById('resultsContainer');
      container.innerHTML = '';
      if (products.length === 0) {
        container.innerHTML = '<p>Нет добавленных товаров. Вернитесь на страницу ввода данных.</p>';
        return;
      }
      let overallTotal = 0;
      // Обрабатываем каждый товар
      products.forEach((product, idx) => {
        // Рассчитываем число коробок и объём
        const boxes = Math.ceil(product.pieces / product.piecesPerPackage);
        const volume = (product.boxLength * product.boxWidth * product.boxHeight) / 1000000;
        // Создаем блок для товара
        let productBlock = document.createElement('div');
        productBlock.className = 'product-block';
        productBlock.innerHTML = `<div class="product-summary">
                                    <h3>${idx + 1}. ${product.productName}${product.productDescription ? ' / ' + product.productDescription : ''}</h3>
                                    <!-- Количество выводим с "шт." -->
                                    <p>Количество: ${product.pieces} шт., Упаковка: ${product.piecesPerPackage} шт.</p>
                                    <p>Коробок: ${boxes}, Размеры: ${product.boxLength} x ${product.boxWidth} x ${product.boxHeight} см, Вес: ${product.boxWeight} кг</p>
                                  </div>`;
        let table = document.createElement('table');
        table.className = 'calc-table';
        table.innerHTML = `<thead>
                             <tr>
                               <th>Услуга</th>
                               <th>Ед. изм.</th>
                               <th>Кол-во</th>
                               <th>Тариф</th>
                               <th>Стоимость</th>
                             </tr>
                           </thead>`;
        let tbody = document.createElement('tbody');
        let totalCost = 0;
        if (!product.selectedServices || product.selectedServices.length === 0) {
          let tr = document.createElement('tr');
          tr.innerHTML = `<td colspan="5" style="text-align:center;">Услуги не выбраны</td>`;
          tbody.appendChild(tr);
        } else {
          // Для каждой выбранной услуги рассчитываем стоимость по индивидуальному тарифу
          product.selectedServices.forEach(serviceName => {
            const service = services.find(s => s.name === serviceName);
            if (service) {
              let multiplier = 0;
              // Определяем множитель в зависимости от единицы измерения
              if (service.unit === "Короб") multiplier = boxes;
              else if (service.unit === "Штука") multiplier = product.pieces;
              else if (service.unit === "Строка") multiplier = 1;
              else if (service.unit === "Куб") multiplier = volume;
              // Определяем значение для расчёта тарифа:
              let countForTariff;
              if (service.unit === "Штука") countForTariff = product.pieces;
              else if (service.unit === "Короб") countForTariff = boxes;
              else if (service.unit === "Куб") countForTariff = volume;
              else if (service.unit === "Строка") countForTariff = 1;
              // Выбираем тариф по порогам: до 1500, 1501-5000, от 5001
              let tariffIndex = countForTariff <= 1500 ? 0 : (countForTariff <= 5000 ? 1 : 2);
              // Определяем текст диапазона для отображения
              let tariffRange = "";
              if (service.unit === "Штука" || service.unit === "Короб" || service.unit === "Куб") {
                tariffRange = countForTariff <= 1500 ? "до 1500" : (countForTariff <= 5000 ? "1501-5000" : "от 5001");
              }
              const rate = service.rates[tariffIndex];
              const cost = multiplier * rate;
              totalCost += cost;
              let tr = document.createElement('tr');
              tr.innerHTML = `<td>${service.name}</td>
                              <td>${service.unit}</td>
                              <td>${multiplier.toFixed(2)}</td>
                              <td>${rate.toFixed(2)} ${tariffRange ? '(' + tariffRange + ')' : ''}</td>
                              <td>${cost.toFixed(2)} ¥</td>`;
              tbody.appendChild(tr);
            }
          });
        }
        table.appendChild(tbody);
        // Строка итоговой стоимости по товару с символом юаня
        let tfoot = document.createElement('tfoot');
        tfoot.innerHTML = `<tr>
                             <td colspan="4" style="text-align:right;"><strong>Итого по товару:</strong></td>
                             <td><strong>${totalCost.toFixed(2)} ¥</strong></td>
                           </tr>`;
        table.appendChild(tfoot);
        productBlock.appendChild(table);
        container.appendChild(productBlock);
        overallTotal += totalCost;
      });
      // Вывод общей стоимости с измененным заголовком и символом юаня
      let overallDiv = document.createElement('div');
      overallDiv.className = 'overall-total';
      overallDiv.innerHTML = `<h2>Стоимость услуг склада: ${overallTotal.toFixed(2)} ¥</h2>`;
      container.appendChild(overallDiv);
    }
    // Функция сброса расчёта: очищает sessionStorage и переходит на страницу ввода данных
    function resetCalculation() {
      if (confirm('Начать новый расчёт? Все данные будут удалены.')) {
        sessionStorage.clear();
        window.location.href = 'index.html';
      }
    }
    // Функция печати страницы
    function printResults() {
      window.print();
    }
    // При загрузке страницы запускаем функцию расчёта
    document.addEventListener('DOMContentLoaded', calculateAndDisplay);
  </script>

  <!-- Футер (нижний колонтитул) -->
  <footer>
    <span class="footer-text">Gabit43<span class="footer-symbol">ⓒ</span></span>
  </footer>
</body>
</html>
