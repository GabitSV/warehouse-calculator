<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Калькулятор услуг склада - Шаг 2: Выбор услуг</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Дополнительные стили для блока предварительного расчёта стоимости */
    .cost-preview { 
      font-weight: bold;      /* Жирный шрифт для стоимости */
      margin-top: 10px;       /* Отступ сверху */
    }
  </style>
</head>
<body class="services-bg">
  <!-- Header: заголовок и индикатор прогресса -->
  <header>
    <h1>Калькулятор услуг склада</h1>
    <div class="progress-bar">
      <div class="step active">1</div>
      <div class="step active">2</div>
      <div class="step">3</div>
    </div>
  </header>

  <!-- Основной блок страницы -->
  <div class="content">
    <h2>Шаг 2: Выбор услуг для каждого товара</h2>
    <form id="servicesForm">
      <!-- Контейнер для динамического создания блоков услуг -->
      <div id="servicesContainer"></div>
      <div class="form-buttons">
        <button type="submit">Перейти к расчёту</button>
      </div>
    </form>
  </div>

  <script>
    /* Массив услуг склада. Для изменения тарифов, единиц измерения и описаний, измените данные в этом массиве. */
    const services = [
      { name: "Погрузо-разгрузочные работы", unit: "Короб", rates: [6.70, 5.70, 4.70], description: "Работы по погрузке и разгрузке." },
      { name: "Пересчет BOX", unit: "Короб", rates: [2.10, 2.00, 1.80], description: "Пересчет количества коробок." },
      { name: "Пересчет PCS", unit: "Штука", rates: [0.60, 0.40, 0.20], description: "Пересчет единиц товара." },
      { name: "Идентификация", unit: "Строка", rates: [20.00, 20.00, 20.00], description: "Идентификация товара." },
      { name: "Видео подтверждение товара", unit: "Строка", rates: [47.97, 47.97, 47.97], description: "Видео подтверждение товара." },
      { name: "Проверка целостности упаковки", unit: "Штука", rates: [0.69, 0.59, 0.49], description: "Проверка целостности упаковки." },
      { name: "Проверка внешней поверхности изделия", unit: "Штука", rates: [0.69, 0.59, 0.46], description: "Проверка внешней поверхности изделия." },
      { name: "Проверка внутренней поверхности изделия", unit: "Штука", rates: [0.69, 0.59, 0.46], description: "Проверка внутренней поверхности изделия." },
      { name: "Проверка комплектации", unit: "Штука", rates: [0.67, 0.57, 0.47], description: "Проверка комплектации." },
      { name: "Проверка на отсутствие резкого запаха", unit: "Штука", rates: [1.10, 1.10, 1.10], description: "Проверка на отсутствие резкого запаха." },
      { name: "Обрезка ниток", unit: "Штука", rates: [1.50, 1.50, 1.50], description: "Обрезка ниток." },
      { name: "Проверка карманов", unit: "Штука", rates: [1.50, 1.50, 1.50], description: "Проверка карманов." },
      { name: "Проверка швов", unit: "Штука", rates: [1.50, 1.50, 1.50], description: "Проверка швов." },
      { name: "Устранение баркодов", unit: "Штука", rates: [0.70, 0.70, 0.70], description: "Устранение баркодов." },
      { name: "Проверка при подключении к источнику питания", unit: "Штука", rates: [2.57, 2.27, 1.97], description: "Проверка при подключении к источнику питания." },
      { name: "Проверка элементов управления", unit: "Штука", rates: [2.57, 2.27, 1.97], description: "Проверка элементов управления." },
      { name: "Проверка работы комплекта", unit: "Штука", rates: [2.57, 2.27, 1.97], description: "Проверка работы комплекта." },
      { name: "Проверка проводных звуковых устройств", unit: "Штука", rates: [2.97, 2.97, 2.97], description: "Проверка проводных звуковых устройств." },
      { name: "Проверка беспроводных звуковых устройств", unit: "Штука", rates: [2.97, 2.97, 2.97], description: "Проверка беспроводных звуковых устройств." },
      { name: "Проверка внешних накопителей", unit: "Штука", rates: [2.97, 2.97, 2.97], description: "Проверка внешних накопителей." },
      { name: "Проклейка баркодов", unit: "Штука", rates: [0.85, 0.75, 0.65], description: "Проклейка баркодов." },
      { name: "Создание набора: Типография", unit: "Штука", rates: [0.87, 0.83, 0.79], description: "Создание набора: Типография." },
      { name: "Создание набора: Товар", unit: "Штука", rates: [1.57, 1.47, 1.37], description: "Создание набора: Товар." },
      { name: "Упаковка в пакеты клиента", unit: "Штука", rates: [0.55, 0.50, 0.45], description: "Упаковка в пакеты клиента." },
      { name: "Проверка фурнитуры и декоративных элементов", unit: "Штука", rates: [2.97, 2.97, 2.97], description: "Проверка фурнитуры и декоративных элементов." },
      { name: "Распечатка баркодов", unit: "Штука", rates: [0.11, 0.11, 0.11], description: "Распечатка баркодов." },
      { name: "Хранение", unit: "Куб", rates: [7.77, 7.77, 7.77], description: "Услуги по хранению." },
      { name: "Тест экрана", unit: "Штука", rates: [2.97, 2.97, 2.97], description: "Тест экрана." },
      { name: "Проверка по ТЗ", unit: "Штука", rates: [5.00, 5.00, 5.00], description: "Проверка по ТЗ." }
    ];
    
    // Получаем товары из sessionStorage
    function getProducts() {
      return JSON.parse(sessionStorage.getItem('productsData')) || [];
    }
    // Сохраняем товары в sessionStorage
    function saveProducts(products) {
      sessionStorage.setItem('productsData', JSON.stringify(products));
    }
    // Функция динамического создания блоков для выбора услуг по каждому товару
    function createServiceBlocks() {
      const products = getProducts();
      const container = document.getElementById('servicesContainer');
      container.innerHTML = '';
      if (products.length === 0) {
        container.innerHTML = '<p>Нет добавленных товаров. Вернитесь на страницу ввода данных.</p>';
        return;
      }
      products.forEach((product, pIndex) => {
        // Блок информации о товаре
        let block = document.createElement('div');
        block.className = 'product-services';
        block.innerHTML = `<div class="product-info">
                             <h3>${pIndex + 1}. ${product.productName}${product.productDescription ? ' / ' + product.productDescription : ''}</h3>
                             <!-- Выводим количество с "шт." -->
                             <p>Количество: ${product.pieces} шт., Упаковка: ${product.piecesPerPackage} шт.</p>
                           </div>`;
        // Таблица со списком услуг
        let table = document.createElement('table');
        table.innerHTML = `<thead>
                             <tr>
                               <th>Выбрать</th>
                               <th>Услуга</th>
                               <th>Ед. изм.</th>
                               <th>Тарифы (до 1500 / 1501-5000 / от 5001)</th>
                             </tr>
                           </thead>`;
        let tbody = document.createElement('tbody');
        // Проходим по массиву услуг и создаём строки таблицы
        services.forEach((service, sIndex) => {
          let tr = document.createElement('tr');
          tr.innerHTML = `<td><input type="checkbox" id="p${pIndex}_s${sIndex}" value="${service.name}"></td>
                          <td title="${service.description}">${service.name}</td>
                          <td>${service.unit}</td>
                          <td>${service.rates.join(' / ')}</td>`;
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        block.appendChild(table);
        // Блок для отображения предварительной стоимости выбранных услуг для данного товара
        let costPreview = document.createElement('div');
        costPreview.className = 'cost-preview';
        costPreview.id = `costPreview_${pIndex}`;
        costPreview.innerText = 'Предварительная стоимость: 0.00';
        block.appendChild(costPreview);
        container.appendChild(block);
        // Назначаем обработчики на каждый чекбокс для обновления стоимости при изменении
        services.forEach((service, sIndex) => {
          const checkbox = document.getElementById(`p${pIndex}_s${sIndex}`);
          checkbox.addEventListener('change', function() {
            updateCostPreview(pIndex);
          });
        });
      });
    }
    // Функция обновления предварительной стоимости для товара
    function updateCostPreview(pIndex) {
      const products = getProducts();
      const product = products[pIndex];
      let selected = [];
      // Считываем выбранные услуги
      services.forEach((srv, idx) => {
        const cb = document.getElementById(`p${pIndex}_s${idx}`);
        if (cb.checked) {
          selected.push(cb.value);
        }
      });
      // Сохраняем временно выбранные услуги
      product.selectedServicesTemp = selected;
      const boxes = Math.ceil(product.pieces / product.piecesPerPackage);
      const volume = (product.boxLength * product.boxWidth * product.boxHeight) / 1000000;
      let cost = 0;
      // Для каждой выбранной услуги рассчитываем стоимость по индивидуальным тарифам
      selected.forEach(serviceName => {
        const service = services.find(s => s.name === serviceName);
        if (service) {
          let multiplier = 0;
          // Определяем множитель в зависимости от единицы измерения
          if (service.unit === "Короб") multiplier = boxes;
          else if (service.unit === "Штука") multiplier = product.pieces;
          else if (service.unit === "Строка") multiplier = 1;
          else if (service.unit === "Куб") multiplier = volume;
          // Выбираем тариф в зависимости от величины, используемой для расчёта
          let countForTariff;
          if (service.unit === "Штука") countForTariff = product.pieces;
          else if (service.unit === "Короб") countForTariff = boxes;
          else if (service.unit === "Куб") countForTariff = volume;
          else if (service.unit === "Строка") countForTariff = 1;
          let tariffIndex = countForTariff <= 1500 ? 0 : (countForTariff <= 5000 ? 1 : 2);
          cost += multiplier * service.rates[tariffIndex];
        }
      });
      document.getElementById(`costPreview_${pIndex}`).innerText = `Предварительная стоимость: ${cost.toFixed(2)}`;
    }
    // Обработчик отправки формы: сохраняем выбранные услуги для каждого товара и переходим к Шагу 3
    document.getElementById('servicesForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const products = getProducts();
      products.forEach((product, pIndex) => {
        let selected = [];
        services.forEach((srv, idx) => {
          const cb = document.getElementById(`p${pIndex}_s${idx}`);
          if (cb && cb.checked) {
            selected.push(cb.value);
          }
        });
        product.selectedServices = selected;
      });
      saveProducts(products);
      window.location.href = 'results.html';
    });
    // При загрузке страницы создаем блоки выбора услуг
    document.addEventListener('DOMContentLoaded', createServiceBlocks);
  </script>

  <!-- Футер (нижний колонтитул) -->
  <footer>
    <span class="footer-text">Gabit43<span class="footer-symbol">ⓒ</span></span>
  </footer>
</body>
</html>
